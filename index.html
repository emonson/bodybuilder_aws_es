<html>
    <head>
        <style>
            .label { margin-right: 0.2em; }
            .label-subjects { background-color: #EBAD60; }
            .label-tags { background-color: #D17869; }
            .label-applied { background-color: #8BAB8D; cursor: pointer; }
            .highlights em { font-weight: bold; }
            .facet_list { cursor: pointer; }
        </style>
    </head>
    <body>
        <div class="container">

            <div class="page-header">
                <p class="lead">Trying out faceted search in AWS Elasticsearch with Fashion IP data.</p>
                <!-- Search box form -->
                <div class="row">
                    <div class="col-lg-6">
                        <form id="search_box_form">
                        <div class="input-group">
                            <input type="search" id="search_box" class="form-control" placeholder="Search for...">
                            <span class="input-group-btn">
                                <button class="btn btn-default" type="submit">Search</button>
                            </span>
                        </div>
                        </form>
                    </div>
                </div>
                <!-- Applied facets list -->
                <div class="row">
                    <div class="col-lg-6" id="facets_applied"></div>
                </div>
            </div>  

            <div class="row">
                <!-- Facets -->
                <div class="col-md-4" id="results_facets">
                    <h4>Subjects</h4>
                    <div class="facet_list" id="facet_subject_tags"></div>
                    <h4>Courts</h4>
                    <div class="facet_list" id="facet_courts"></div>
                    <h4>Tags</h4>
                    <div class="facet_list" id="facet_tags"></div>
                </div>
                <!-- Results -->
                <div class="col-md-8">
                    <div id="results_body"></div>
                </div>

            </div>
        </div>  <!-- container -->
        
        <!-- REQUIREMENTS -->
        <script type="text/javascript" src="//code.jquery.com/jquery-1.12.3.js"></script>
        <script type="text/javascript" src="bodybuilder.min.js" charset="utf-8"></script>
        <script type="text/javascript" src="elasticsearch.min.js" charset="utf-8"></script>
        <script type="text/javascript" src="handlebars.min.js" charset="utf-8"></script>
        <link rel="stylesheet" type="text/css" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
        
        <!-- RESULTS BODY TEMPLATE -->
        <script id="body_template" type="text/x-handlebars-template">
            <div id="outer_result_loop">
            {{#each hits}}
                <div class="result_entry">
                    <h4 class="result_title">{{_source.ref_summary}}</h4>
                    <p><strong>{{_source.court}}</strong></p>
                    <p><a href="http://{{_source.url}}">{{_source.url}}</a></p>
                    <p>
                    {{#each highlight.content}}
                        <span class="highlights">{{{this}}}</span> &mdash; 
                    {{/each}}
                    </p>
                    <p>Subjects: 
                    {{#each _source.subject_tags}}
                        <span class="label label-subjects">{{{this}}}</span>
                    {{/each}}
                    </p>
                    <p>Tags: 
                    {{#each _source.tags}}
                        <span class="label label-tags">{{{this}}}</span>
                    {{/each}}
                    </p>
                    <hr />
                </div>
            {{/each}}
            </div>
        </script>

        <!-- FACETS TEMPLATE -->
        <script id="facet_template" type="text/x-handlebars-template">
            <ul class="facet_list">
            {{#each buckets}}
                <li class="facet_entry" id="{{../facet_name}}|{{key}}" onclick="facet_click(this.id)">{{key}} ({{doc_count}})</li>
            {{/each}}
            </ul>
        </script>
        
        <!-- APPLIED FACETS LIST TEMPLATE -->
        <script id="applied_facets_template" type="text/x-handlebars-template">
            {{#each applied}}
                <span class="label label-applied" id="{{{this}}}" onclick="facet_remove(this.id)">
                    {{{this}}}
                    <span class="glyphicon glyphicon-remove"></span>
                </span>
            {{/each}}
        </script>            

        <!-- BEHAVIOR -->
        <script>
            // Establish connection with Elasticsearch server
            var client = new elasticsearch.Client({
                host: 'search-dvstest-ssbfvmt2tjfvm7jj6qh2jtmuvi.us-west-2.es.amazonaws.com',
                apiVersion: '5.0',
                log: 'trace'
            });
            
            // Search input callback setup
            $( "#search_box_form" ).submit(function( event ) {
                fulltext_search();
                event.preventDefault();
            });
            
            // Compile templates
            var source = $("#body_template").html();
            var template_body = Handlebars.compile(source);
            source = $("#facet_template").html();
            var template_facet = Handlebars.compile(source);
            source = $("#applied_facets_template").html();
            var template_applied_facets = Handlebars.compile(source);
            
            // Initialize query variables
            var exclude_fields = ['content', 'subjects', 'filename', 'referenced', 
                                    'media_type', 'file_ref'];
            var query_string = '*';
            var query_facets_list = [];
            
            // Main search function
            var fulltext_search = function() {
            
                // Just grab query string fresh from input each time
                query_string = $("#search_box").val();
                
                // Base default query
                var es_body = bodybuilder()
                    .rawOption('_source', { 'excludes': exclude_fields })
                    .size(10)
                    .query('query_string', {'default_field':'content', 'query':query_string})
                    .aggregation('terms', 'court_level_name')
                    .aggregation('terms', 'subject_tags')
                    .aggregation('terms', 'tags')
                    .rawOption( "highlight", { "fields": { "content": {} } } );
                
                // Add facet filters from list to query
                $.each(query_facets_list, function(idx, sobj) {
                    var fs = sobj.split('|');
                    es_body.filter('term', fs[0], fs[1]);
                });

                client.search({
                    index: 'fashion_test',
                    type: 'case',
                    body: es_body.build()
                }).then(function (body) {
                    var hits = body.hits;
                    var aggs = body.aggregations;
                
                // Do something with search results!
                var html_results_body = template_body(hits);
                $("#results_body").html(html_results_body);
        
                aggs.agg_terms_subject_tags.facet_name = "subject_tags";
                var html_facet_subject_tags = template_facet(aggs.agg_terms_subject_tags);
                $("#facet_subject_tags").html(html_facet_subject_tags);
        
                aggs.agg_terms_court_level_name.facet_name = "court_level_name";
                var html_facet_courts = template_facet(aggs.agg_terms_court_level_name);
                $("#facet_courts").html(html_facet_courts);
        
                aggs.agg_terms_tags.facet_name = "tags";
                var html_facet_tags = template_facet(aggs.agg_terms_tags);
                $("#facet_tags").html(html_facet_tags);
                
                var html_applied_facets = template_applied_facets({'applied':query_facets_list});
                console.log(html_applied_facets);
                $("#facets_applied").html(html_applied_facets);
                
                }, function (error) {
                    console.trace(error.message);
                });
            
            }; // fulltext_search
            
            // http://stackoverflow.com/a/4825325
            var facet_click = function(facet_id){
                query_facets_list.push(facet_id);
                fulltext_search();
            }; 
            
            var facet_remove = function(facet_id){
                var idx = query_facets_list.indexOf(facet_id);
                if (idx > -1) {
                    query_facets_list.splice(idx, 1);
                }
                fulltext_search();
            }; 
            
        </script>
    </body>
</html>
